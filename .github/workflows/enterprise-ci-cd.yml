name: Enterprise CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  PYTHON_VERSION: '3.11'

jobs:
  security-audit:
    name: Security & Compliance Audit
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'

    - name: Install Security Tools
      run: |
        python -m pip install --upgrade pip
        pip install bandit safety flake8 pylint
        echo "Security tools installed successfully"

    - name: Run Bandit Security Scan
      run: |
        echo "Running Bandit security analysis..."
        bandit -r . -f json -o bandit-report.json || true
        bandit -r . -f txt || echo "Bandit completed with warnings"

    - name: Run Safety Vulnerability Check
      run: |
        echo "Checking for known security vulnerabilities..."
        safety check --json --output safety-report.json || true
        safety check || echo "Safety check completed with warnings"

    - name: Code Quality Check
      run: |
        echo "Running code quality analysis..."
        flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics || true
        find . -name "*.py" -type f | head -5 | xargs pylint --exit-zero || true

    - name: Compliance Verification
      run: |
        echo "Verifying compliance requirements..."
        
        # Check license file
        if [ -f "LICENSE" ] || [ -f "LICENSE.md" ] || [ -f "LICENSE.txt" ]; then
          echo "âœ… License file found"
        else
          echo "âŒ No license file found"
          exit 1
        fi
        
        # Check security policy
        if [ -f "SECURITY.md" ]; then
          echo "âœ… Security policy found"
        else
          echo "âŒ No security policy found"
          exit 1
        fi
        
        # Verify disclaimer in main files
        echo "Checking for risk disclaimer..."
        if grep -q "Use of this code is at your own risk" main.py; then
          echo "âœ… Risk disclaimer found in main.py"
        else
          echo "âŒ Missing risk disclaimer in main.py"
          exit 1
        fi

    - name: Upload Security Reports
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: security-reports
        path: |
          bandit-report.json
          safety-report.json

  code-quality:
    name: Code Quality & Testing
    runs-on: ubuntu-latest
    needs: security-audit

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'

    - name: Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install flake8 pytest
        echo "Basic dependencies installed"

    - name: Lint Code
      run: |
        echo "Running code linting..."
        flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
        echo "Linting completed successfully"

    - name: Test Application
      run: |
        echo "Testing main application..."
        python main.py
        echo "Application test completed successfully"

    - name: Validate Python Syntax
      run: |
        echo "Validating Python syntax..."
        python -m py_compile main.py
        find . -name "*.py" -type f | head -10 | xargs python -m py_compile
        echo "Syntax validation completed"

  deployment-ready:
    name: Deployment Readiness Check
    runs-on: ubuntu-latest
    needs: [security-audit, code-quality]
    if: always()

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Generate Deployment Report
      run: |
        echo "# Deployment Readiness Report" > deployment-report.md
        echo "" >> deployment-report.md
        echo "**Date:** $(date)" >> deployment-report.md
        echo "**Repository:** ${{ github.repository }}" >> deployment-report.md
        echo "**Branch:** ${{ github.ref_name }}" >> deployment-report.md
        echo "**Commit:** ${{ github.sha }}" >> deployment-report.md
        echo "" >> deployment-report.md
        echo "## Pipeline Results" >> deployment-report.md
        echo "" >> deployment-report.md
        echo "- Security Audit: ${{ needs.security-audit.result }}" >> deployment-report.md
        echo "- Code Quality: ${{ needs.code-quality.result }}" >> deployment-report.md
        echo "" >> deployment-report.md
        
        if [[ "${{ needs.security-audit.result }}" == "success" && "${{ needs.code-quality.result }}" == "success" ]]; then
          echo "## âœ… DEPLOYMENT STATUS: READY" >> deployment-report.md
          echo "" >> deployment-report.md
          echo "All security and quality checks have passed successfully." >> deployment-report.md
          echo "The application is ready for enterprise deployment." >> deployment-report.md
        else
          echo "## âŒ DEPLOYMENT STATUS: NOT READY" >> deployment-report.md
          echo "" >> deployment-report.md
          echo "Some checks have failed. Please review the pipeline results." >> deployment-report.md
        fi
        
        echo "" >> deployment-report.md
        echo "---" >> deployment-report.md
        echo "*Generated by Enterprise CI/CD Pipeline*" >> deployment-report.md
        
        cat deployment-report.md

    - name: Upload Deployment Report
      uses: actions/upload-artifact@v4
      with:
        name: deployment-report
        path: deployment-report.md

    - name: Final Status Check
      run: |
        if [[ "${{ needs.security-audit.result }}" == "success" && "${{ needs.code-quality.result }}" == "success" ]]; then
          echo "ğŸ‰ Enterprise CI/CD Pipeline completed successfully!"
          echo "âœ… All security and quality gates passed"
          echo "ğŸš€ Application ready for deployment"
        else
          echo "âš ï¸ Pipeline completed with issues"
          echo "Please review failed jobs and fix issues before deployment"
          exit 1
        fi