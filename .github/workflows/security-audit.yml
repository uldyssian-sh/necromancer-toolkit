name: Security Audit & Compliance

on:
  push:
    branches: [ main, develop, refactor/* ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    - cron: '0 2 * * *'  # Daily at 2 AM UTC

env:
  PYTHON_VERSION: '3.11'

jobs:
  security-scan:
    name: Security Vulnerability Scan
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
      actions: read

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Install Security Tools
      run: |
        python -m pip install --upgrade pip
        pip install bandit[toml] safety semgrep
        
    - name: Run Bandit Security Linter
      run: |
        bandit -r . -f json -o bandit-report.json || true
        bandit -r . -f txt
      continue-on-error: true

    - name: Run Safety Check
      run: |
        safety check --json --output safety-report.json || true
        safety check
      continue-on-error: true

    - name: Run Semgrep Security Analysis
      run: |
        semgrep --config=auto --json --output=semgrep-report.json . || true
        semgrep --config=auto .
      continue-on-error: true

    - name: Upload Security Reports
      uses: actions/upload-artifact@v3
      with:
        name: security-reports
        path: |
          bandit-report.json
          safety-report.json
          semgrep-report.json

  dependency-scan:
    name: Dependency Vulnerability Scan
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Run Trivy Vulnerability Scanner
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: 'fs'
        scan-ref: '.'
        format: 'sarif'
        output: 'trivy-results.sarif'

    - name: Upload Trivy Results
      uses: github/codeql-action/upload-sarif@v2
      if: always()
      with:
        sarif_file: 'trivy-results.sarif'

  secrets-scan:
    name: Secrets Detection
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Run GitLeaks
      uses: gitleaks/gitleaks-action@v2
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        GITLEAKS_LICENSE: ${{ secrets.GITLEAKS_LICENSE }}

  code-quality:
    name: Code Quality Analysis
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Install Quality Tools
      run: |
        python -m pip install --upgrade pip
        pip install flake8 pylint black isort mypy
        
    - name: Run Flake8
      run: |
        flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
        flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics

    - name: Run PyLint
      run: |
        pylint **/*.py --exit-zero --output-format=text --reports=yes

    - name: Check Code Formatting
      run: |
        black --check --diff .
        isort --check-only --diff .

    - name: Run MyPy Type Checking
      run: |
        mypy . --ignore-missing-imports --no-strict-optional

  infrastructure-scan:
    name: Infrastructure Security Scan
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Run Checkov
      uses: bridgecrewio/checkov-action@master
      with:
        directory: .
        framework: all
        output_format: sarif
        output_file_path: checkov-results.sarif

    - name: Upload Checkov Results
      uses: github/codeql-action/upload-sarif@v2
      if: always()
      with:
        sarif_file: checkov-results.sarif

  compliance-check:
    name: Compliance Verification
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Check License Compliance
      run: |
        echo "Checking for license files..."
        if [ ! -f "LICENSE" ] && [ ! -f "LICENSE.md" ] && [ ! -f "LICENSE.txt" ]; then
          echo "âŒ No license file found"
          exit 1
        fi
        echo "âœ… License file found"

    - name: Check Security Policy
      run: |
        echo "Checking for security policy..."
        if [ ! -f "SECURITY.md" ]; then
          echo "âŒ No security policy found"
          exit 1
        fi
        echo "âœ… Security policy found"

    - name: Check Code of Conduct
      run: |
        echo "Checking for code of conduct..."
        if [ ! -f "CODE_OF_CONDUCT.md" ]; then
          echo "âš ï¸ No code of conduct found (recommended)"
        else
          echo "âœ… Code of conduct found"
        fi

    - name: Verify Disclaimer
      run: |
        echo "Checking for risk disclaimer in Python files..."
        missing_disclaimer=0
        for file in $(find . -name "*.py" -type f); do
          if ! grep -q "Use of this code is at your own risk" "$file"; then
            echo "âŒ Missing disclaimer in: $file"
            missing_disclaimer=1
          fi
        done
        if [ $missing_disclaimer -eq 0 ]; then
          echo "âœ… All Python files contain risk disclaimer"
        else
          echo "âŒ Some files missing risk disclaimer"
          exit 1
        fi

  security-report:
    name: Generate Security Report
    runs-on: ubuntu-latest
    needs: [security-scan, dependency-scan, secrets-scan, code-quality, infrastructure-scan, compliance-check]
    if: always()
    
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Download Security Reports
      uses: actions/download-artifact@v3
      with:
        name: security-reports
        path: ./reports/
      continue-on-error: true

    - name: Generate Security Summary
      run: |
        echo "# Security Audit Summary" > security-summary.md
        echo "" >> security-summary.md
        echo "**Date:** $(date)" >> security-summary.md
        echo "**Repository:** ${{ github.repository }}" >> security-summary.md
        echo "**Branch:** ${{ github.ref_name }}" >> security-summary.md
        echo "" >> security-summary.md
        echo "## Scan Results" >> security-summary.md
        echo "" >> security-summary.md
        echo "- âœ… Security Vulnerability Scan: ${{ needs.security-scan.result }}" >> security-summary.md
        echo "- âœ… Dependency Scan: ${{ needs.dependency-scan.result }}" >> security-summary.md
        echo "- âœ… Secrets Detection: ${{ needs.secrets-scan.result }}" >> security-summary.md
        echo "- âœ… Code Quality: ${{ needs.code-quality.result }}" >> security-summary.md
        echo "- âœ… Infrastructure Scan: ${{ needs.infrastructure-scan.result }}" >> security-summary.md
        echo "- âœ… Compliance Check: ${{ needs.compliance-check.result }}" >> security-summary.md
        echo "" >> security-summary.md
        echo "## Security Status" >> security-summary.md
        echo "" >> security-summary.md
        if [[ "${{ needs.security-scan.result }}" == "success" && "${{ needs.dependency-scan.result }}" == "success" && "${{ needs.secrets-scan.result }}" == "success" ]]; then
          echo "ðŸŸ¢ **PASSED** - All security checks completed successfully" >> security-summary.md
        else
          echo "ðŸ”´ **FAILED** - Some security checks failed or have warnings" >> security-summary.md
        fi
        
        cat security-summary.md

    - name: Upload Security Summary
      uses: actions/upload-artifact@v3
      with:
        name: security-summary
        path: security-summary.md